---
title: "Logistic Regression: Prediction"
author: "Prof. Maria Tackett"
date: "2024-11-12"
date-format: "MMM DD, YYYY"
footer: "[ðŸ”— STA 221 - Fall 2024](https://sta221-fa24.netlify.app)"
logo: "../images/logo.png"
format: 
  revealjs:
    theme: slides.scss
    multiplex: false
    transition: fade
    slide-number: false
    incremental: false 
    chalkboard: true
html-math-method:
  method: mathjax
  url: "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
execute:
  freeze: auto
  echo: true
knitr:
  opts_chunk: 
    R.options:      
    width: 200
---

```{r setup, include=FALSE, echo=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
	fig.align = "center",
	fig.height =5,
	fig.width = 8,
	message = FALSE,
	warning = FALSE,
	echo = FALSE
)
```

## Announcements

## Computational set up

```{r}
#| warning: false
#| message: false


library(tidyverse)
library(tidymodels)
library(pROC)       # make ROC curves
library(knitr)
library(kableExtra)

# set default theme in ggplot2
ggplot2::theme_set(ggplot2::theme_bw())
```

## Topics

-   Calculating predicted probabilities from the logistic regression model

-   Using predicted probabilities to classify observations

-   Make decisions and assess modelperformance using

    -   Confusion matrix
    -   ROC curve

## Data: Risk of coronary heart disease

This data set is from an ongoing cardiovascular study on residents of the town of Framingham, Massachusetts. We want to examine the relationship between various health characteristics and the risk of having heart disease.

-   `high_risk`: 1 = High risk of having heart disease in next 10 years, 0 = Not high risk of having heart disease in next 10 years

-   `age`: Age at exam time (in years)

-   `totChol`: Total cholesterol (in mg/dL)

-   `currentSmoker`: 0 = nonsmoker; 1 = smoker

```{r}
#| echo: false
heart_disease <- read_csv("data/framingham.csv") |>
  select(age, totChol, TenYearCHD, currentSmoker) |>
  drop_na() |>
  mutate(high_risk = as_factor(TenYearCHD), 
         currentSmoker = as_factor(currentSmoker))
```

# Recap

<!--# add some recap slides-->

## Modeling risk of coronary heart disease

```{r}
heart_disease_fit <- glm(high_risk ~ age + totChol + currentSmoker, 
              data = heart_disease, family = "binomial")

tidy(heart_disease_fit, conf.int = TRUE) |> 
  kable(digits = 3)
```

## Prediction and classification

-   We are often interested in using the model to classify observations, i.e., predict whether a given observation will have a 1 or 0 response

-   For each observation

    -   Use the logistic regression model to calculate the predicted log-odds the response for the $i^{th}$ observation is 1
    -   Use the log-odds to calculate the predicted probability the \$i\^{th} observation is 1
    -   Then, use the predicted probabilities to classify the observation as having a 1 or 0 response using some predefined threshold

## Predicted log-odds

```{r}
heart_disease_aug <- augment(heart_disease_fit)
heart_disease_aug |> select(.fitted)
```

```{r}
#| echo: false
heart_disease_aug |> 
  select(.fitted) |> 
  slice(1:5)
```

. . .

**Observation 1**

$$
\text{predicted log-odds} = \log(\hat{\omega}) = \log\Big(\frac{\hat{\pi}}{1- \hat{\pi}}\Big) = -3.06
$$

<!--# do i want to deal with residuals? Maybe hide those for now?-->

## Predicted probability 

```{r}
#| echo: false
heart_disease_aug |> 
  select(.fitted) |> 
  slice(1:5)
```

. . .

**Observation 1**

$$
\text{predicted odds} = \hat{\omega} = \frac{\hat{\pi}}{1- \hat{\pi}} = \exp\{-3.06\} = 0.0469
$$

## Predicted probability 

```{r}
#| echo: false
heart_disease_aug |> 
  select(.fitted) |> 
  slice(1:5)
```

. . .

**Observation 1**

$$
\text{predicted prob.} = \hat{\pi} = \frac{\hat{\omega}}{1+\hat{\omega}} = \frac{\exp\{-3.06\}}{1 + \exp\{-3.06\}}= 0.045
$$

. . .

::: question
Would you classify this individual as high risk $(\hat{y} = 1)$ or not high risk $(\hat{y} = 0)$?
:::

## Another individual 

```{r}
#| echo: false
heart_disease_aug |> 
  select(.fitted) |> 
  slice(1:5)
```

. . .

**Observation 4**

$$
\text{predicted prob.} = \hat{\pi} = \frac{\hat{\omega}}{1+\hat{\omega}} = \frac{\exp\{-0.751\}}{1 + \exp\{-0.751\}}= 0.321
$$

. . .

::: question
Would you classify this individual as high risk $(\hat{y} = 1)$ or not high risk $(\hat{y} = 0)$?
:::

## Predictions in R

We can calculate predicted probabilities using the `predict.glm()` function. Use `type = "response"` to get probabilities.[^1]

[^1]: The default is `type = "link"`, which produces the predicted log-odds.

<br>

. . .

```{r}
#| eval: false
#| echo: true
predict.glm(heart_disease_fit, type = "response")
```

. . .

**Predicted probabilities for Observations 1 -5**

```{r}
#| echo: false
predict.glm(heart_disease_fit, type = "response")[1:5]
```

## Predictions in R

```{r}
#| echo: true

pred_prob <- predict.glm(heart_disease_fit, type = "response")

heart_disease_aug <- heart_disease_aug |> 
  bind_cols(pred_prob = pred_prob)
```

. . .

```{r}
#| echo: false

heart_disease_aug  |> 
  select(high_risk, .fitted, pred_prob) |>
  slice(1:5)
```

## Classifying observations

::: question
-   What threshold would you use to classify observations as high risk or not high risk?

-   What considerations did you make to determine the threshold?
:::

## Default predictions in R

We can use the `predict.glm()` function in R to produce the predicted class for each observation

```{r}
predict.glm(heart_disease_fit, type = "response")
```
