---
title: "Lab 05: Expanding Multiple Linear Regression"
author: "Add your name here"
date: today
execute:
  freeze: auto
  echo: true
  evaluate: true
  warning: false
  message: false
format: html
---

::: callout-important
## Date due

-   Add dates
-   Add dates
:::

# Expanding Multiple Linear Regression

In this lab, we will explore how to address and interpret the presence of qualitative variables among the predictors and estimating the effect of interaction between dependent variables.

## Packages

For today's lab, we will be using the following packages.

```{r packages}
library(tidyverse)
```

## Data

The data for today's lab is an extract from the [Equity in Athletics Data Analysis](https://ope.ed.gov/athletics/#/datafile/list), reporting data about student body composition, per-sport expenditure and revenues for US NCAA Division I colleges.

<!--# This is data cleaned from a tidytuesday data set-->

```{r read_data}
sports <- read_csv("data/ncaa-revenues.csv")
```

We will investigate whether school features affect the revenues of athletics programs in different sports. Here is a table describing the variables in the data.

Link to data dictionary on tidytuesday: <https://github.com/rfordatascience/tidytuesday/blob/master/data/2022/2022-03-29/readme.md>

**The goal of the analysis is to use various features to explain variability in total revenue from athletics for NCAA colleges and universities.**

## Exercises

### Exercise 1

We begin by rescaling the response variable `total_rev_menwomen` and primary predictor variable `total_exp_menwomen`, so that they are in \$100k.

Why might we rescale these variables instead of using them in the original units?

Create new variables `rev100k` and `exp_100k` that are the rescaled versions of revenue and expenditures, respectively.

### Exercise 2

From this plot, we can notice a few features that can be used as guides to transform the data and make it more amenable to a regression analysis.

-   Make a visualization of the relationship between revenue and expenditures. Use the plot to describe the relationship between the two variables.

```{=html}
<!-- -->
```
-   Higher values of both expenditures and revenues are associated with greater variability. Transform both variables and place them on a logarithmic scale.
-   Larger values seem to follow a slightly different trend and are associated with two sports: football and basketball. Create an indicator variable encoding whether the observation refers to either of those two sports or not.

### Exercise 3

With these transformations, we can notice one further thing: a lot of observations display a perfect one-to-one relationship between expenses and revenues. Provide a possible interpretation of this phenomenon. Would you think it is reasonable to include observations displaying this exact relationship?

Create a new dataset filtering out the observations for which expenditures and revenues are exactly equal. Call the new data set `sports_nolinear`.

```{r}
#| include: false
sports <- sports |> 
  mutate(basket_football = 
           as.factor(if_else(sports=="Basketball"|sports=="Football", 1, 0)),
        exp_100k = total_exp_menwomen / 100000,
        rev_100k = total_rev_menwomen / 100000,
         log_exp = log(exp_100k),
         log_rev = log(rev_100k))

sports_nolinear <- sports |>
  filter(log_exp != log_rev)
```

### Exercise 4

Using this newly created dataset, regress log-revenue on log-expenditures, student body size, school type, sport type, sport participation for men and women and the basketball/football indicator you created. Furthermore, include an interaction term between log-expenses and the indicator for basketball or football.

### Exercise 5

Inspect the regression coefficients. What type of school and sport corresponds to the baseline intercept?

You'll notice that one coefficient is a missing value. What happened? What is the technical name of this phenomenon?

### Exercise 6

For the sake of interpretability, it is useful to have a regression model in which no coefficients are missing, and the coefficients on each sport indicator represent the baseline for such sport. Run another regression model on the same covariates as before, making sure to drop the necessary variables (and the intercept) to achieve this.

```{r}
#| echo: true
reg2 <- lm(log_rev ~ -1 + sports + students_1k + sector_name + sum_partic_men + 
            sum_partic_women + log_exp + 
            log_exp*basket_football - basket_football,
          data = sports_nolinear)
```

You will notice that we have another indicator variable in our model, corresponding to school type. Which type of school was chosen to be the baseline in this model?

### Exercise 7

Now that we have an interpretable model, let us assess the fit and perform some diagnostics to verify whether our linear regression assumptions are reasonable for this data. As a first step, provide some overall measures of model fit and comment on whether it seems to have an acceptable predictive power on the response of interest.

### Exercise 8

Let us inspect the residuals for the model. A concern we may have is that, since each university has athletic programs in multiple sports, the deviations from the mean may be correlated across institutions. To verify if this is the case, draw a fitted-residual scatterplots and color code each point by institution code. Comment on the output and discuss whether errors seem to be correlated within institutions.

### Exercise 9

In the previous plot, we can notice two things. Firstly, there seems to be two groups of observations: larger fitted values correspond to lower variance in the residuals compared to the rest. Secondly, in the low fitted values group some observations have large negative residuals, which may indicative of outliers.

To check whether this seems to indicate some model misspecification, we compute a variation of the above plot. Compute the studentized residuals and Cook's distance for the model, and plot fitted values against residuals. Now, color code the points based on the computed Cook's distance and have different point shapes for whter the observation corresponds to basketball or football. Comment on the plot and address the two concerns detailed above.

```{r}
#| echo: false

library(tidymodels)
sports_aug <- augment(reg2)
ggplot(sports_aug) +
  geom_point(mapping = aes(x = .fitted,
                           y = .std.resid,
                           color = .cooksd,
                           shape = as.factor(basket_football)))
```

### Exercise 10

Comment on whether our linear regression model seems to be appropriate for the data and provide a brief commentary of the result by interpreting the regression coefficients and their significance.
